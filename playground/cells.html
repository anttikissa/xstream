<!doctype html>
<head>
<title>Cells test</title>
<script src='../dist/xstream.js'></script>
<script>
window.addEventListener('load', function() {

	// Tired of typing console.log everywhere.
	var log = console.log.bind(console);

	// A stream that updates on every DOM event of type 'event' on 'el'.
	function eventStream(el, event) {
		var result = stream();
		el.addEventListener(event, function(e) {
			result.update(e.target.value);
		});
		return result;
	}

	// Update DOM element's .value whenever 'stream' updates.
	function assign(stream, el) {
		stream.forEach(function(value) {
			el.value = value;
		});
	}

	// Collection of all cells, indexed by id like 'A1'
	var cells = {};

	// Shorthand for document.createElement.
	function elem(type) {
		return document.createElement(type);
	}

	// Convert a string to an actual value
	// e.g. '1' -> 1, 'abc' -> 'abc'
	function convert(str) {
		var number = Number(str);
		if (isNaN(number))
			return str;
		return number;
	}

	function looksLikeDynamic(s) {
		return s[0] === '=';
	}

	function cell(id) {
		var el = elem('input');

		// A hack to create column and row headers
		if (id[0] === ' ' || id[1] === ' ') {
			el.disabled = true;
			el.value = id;
			return el;
		}

		cells[id] = el;
		el.value = 0;
		
		el.inputValues = eventStream(el, 'change').log(id + ' changes');

		el.dynamic = stream();
		el.stream = stream.merge(
			el.inputValues
				.filter(stream.util.not(looksLikeDynamic))
				.map(convert).log(id + ' converted'),
			el.dynamic).name(id);

		assign(el.stream, el);

		// On input values like '=<formula>':
		// - turn <formula> into a function,
		// - use stream.combine() to make a stream that uses the function to 
		//   combine the value streams the cells it refers to,
		// - rewire el.dynamic with the aforementioned stream,
		// - and save the formula in el.formula.
		el.inputValues.filter(looksLikeDynamic).forEach(function(value) {
			var formula = value.substr(1);
			var refs = formula.match(/[A-Z][0-9]+/g) || [];
			var f = new Function(refs.join(','), "return " + formula + ";");
			var combineArgs = refs.map(function(ref) {
				return cells[ref].stream;
			}).concat(f);
			var dynamic = stream.combine.apply(undefined, combineArgs);
			el.dynamic.rewire(dynamic);
			// trigger first update - TODO more elegant way to do this?
			if (refs.length) {
				cells[refs[0]].stream.update(cells[refs[0]].stream.value);
			}
			el.formula = formula;
		});

		// Bootstrap the value stream with the initial value.
		el.stream.update(convert(el.value));

		return el;
	}

	// Shorthand for document.body.appendChild.
	function push(elem) {
		document.body.appendChild(elem);
	}

	// Populate the DOM with cells.
	[' ', 1,2,3,4,5,6,7,8,9,10].forEach(function(row) {
		" ABCDEFGHI\n".split('').forEach(function(column) {
			if (column === '\n')
				push(elem('br'));
			else
				push(cell(column + row));
		});
	});

	// And focus on the first one.
	cells.A1.focus();

	// A small test.
	setTimeout(function() {
		cells.B1.inputValues.update('=A1 + 1');
		cells.C1.inputValues.update('=B1 + 2');
		cells.A1.inputValues.update('123');
	}, 100);
});
</script>
<style>
	input {
		margin: 0;
		width: 100px;
	}

	input:disabled {
		background: #eee;
	}
</style>


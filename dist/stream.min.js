function toArray(t){return Array.prototype.slice.apply(t)}function access(t){if("."!==t[0])throw new Error("invalid",t);var e=t.slice(1);return function(t){return t[e]}}function Stream(t){this.listeners=[],this.parents=[],this.children=[],this.value=void 0,this.id=stream.nextId++,void 0!==t&&this.set(t)}function depends(){for(var t=arguments.length,e=arguments[t-2],n=arguments[t-1],r=0;t-2>r;r++)arguments[r].children.push(e),e.parents.push(arguments[r]);return e.f=n,e}function hasNewValue(t){return t.hasOwnProperty("newValue")}function mostRecentValue(t){return t.hasOwnProperty("newValue")?t.newValue:t.value}function keys(t){if(Object.keys)return Object.keys(t);var e=[];for(var n in t)t.hasOwnProperty(n)&&e.push(n);return e}function find(t,e){for(var n=0,r=t.length;r>n;n++){var a=t[n];if(e(a))return a}}function deferNextTick(t){function e(){n||t()}var n=!1;return process.nextTick(e),function(){n=!0}}function deferTimeout(t){var e=setTimeout(t);return function(){clearTimeout(e)}}function Transaction(){var t=this;this.cancel=defer(function(){t.commit()}),this.ops=[]}function updateOrder(t){function e(t){allNodes.hasOwnProperty(t.id)||(allNodes[t.id]=t,t.children.forEach(function(t){parentCounts[t.id]=(parentCounts[t.id]||0)+1,e(t)}))}function n(t){var e=allNodes[t];e.children.forEach(function(t){parentCounts[t.id]--}),delete parentCounts[t],delete allNodes[t],nodesToUpdate.push(e)}for(parentCounts={},allNodes={},nodesToUpdate=[],t.forEach(function(t){parentCounts[t.id]=0,e(t)});;){var r=keys(parentCounts);if(0===r.length)break;var a=find(r,function(t){return 0===parentCounts[t]});n(a)}return nodesToUpdate}var log=function(){};Stream.prototype.broadcast=function(){for(var t=0,e=this.listeners.length;e>t;t++)this.listeners[t](this.value)},Stream.prototype.forEach=function(t){return this.listeners.push(t),this},Stream.prototype.set=function(t){var e=this,n=stream.transaction();return n.set(e,t),this},Stream.prototype.map=function(t){var e=this;return depends(e,stream(),function(){this.newValue=t(e.newValue)}).endWhen(this)},Stream.prototype.filter=function(t){var e=this;return depends(this,stream(),function(){t(e.newValue)&&(this.newValue=e.newValue)})},Stream.prototype.uniq=function(){var t=this;return depends(this,stream(),function(){this.value!==t.newValue&&(this.newValue=t.newValue)})},Stream.prototype.reduce=function(t,e){var n=this;return depends(this,stream(),function(){this.newValue=void 0!==this.value?t(this.value,n.newValue):void 0!==e?t(e,n.newValue):n.newValue}).endWhen(n)},Stream.prototype.collect=function(){return this.reduce(function(t,e){return t.concat(e)},[])},Stream.prototype.rewire=function(t){for(var e=0,n=this.parents.length;n>e;e++){var r=this.parents[e];r.children.splice(r.children.indexOf(this))}return this.parents=[],depends(t,this,function(){this.newValue=t.newValue})},Stream.prototype.toString=function(){function t(t,e){void 0!==e&&(n+=", "+t+": "+e)}function e(e,n){t(e,"["+n.map(function(t){return"s"+t.id}).join(", ")+"]")}var n="[Stream s"+this.id;return t("value",this.value),e("parents",this.parents),e("children",this.children),n+"]"},Stream.prototype.inspect=function(){return this.toString()},Stream.prototype.commit=function(){return stream.transaction().commit(),this},Stream.prototype.f=function(){},Stream.prototype.ends=function(){return this.endStream||(this.endStream=stream()),this.endStream},Stream.prototype.end=function(){this.endStream&&this.endStream.set(this.value)},Stream.prototype.endWhen=function(t){return this.ends().rewire(t.ends()),this},Stream.prototype.onEnd=function(t){this.ends().forEach(t)};var stream=function(t){return new Stream(t)};stream.nextId=1,stream.transaction=function(){return stream.tx||(stream.tx=new Transaction)},stream.fromArray=function(t){var e=stream(),n=function(){t.length?(e.set(t.shift()),defer(n)):e.end()};return n(),e},stream.fromValues=function(){var t=Array.prototype.slice.call(arguments);return stream.fromArray.call(stream,t)},stream.fromString=function(t){return stream.fromArray(t.split(""))},stream.combine=function(){var t=toArray(arguments),e=t.pop(),n=t.concat([stream(),function(){this.newValue=e.apply(null,t.map(mostRecentValue))}]);return depends.apply(null,n)},stream.merge=function(){var t=toArray(arguments),e=t.concat([stream(),function(){for(var e=this,n=0,r=t.length;r>n;n++)hasNewValue(t[n])&&(e.newValue=t[n].newValue)}]);return depends.apply(null,e)},stream.zip=function(){var t=toArray(arguments);return t.push(Array),stream.combine.apply(null,t)};var defer="undefined"!=typeof process&&process.nextTick?deferNextTick:deferTimeout;Transaction.prototype.set=function(t,e){this.ops.push([t,e])},Transaction.prototype.commit=function(){this.cancel&&this.cancel(),stream.tx===this&&delete stream.tx;for(var t={},e=[],n=0,r=this.ops.length;r>n;n++){var a=this.ops[n],i=a[0];i.newValue=a[1],t[i.id]||(e.push(i),t[i.id]=!0)}var o=updateOrder(e);o.forEach(function(t){t.f()}),o.forEach(function(t){hasNewValue(t)&&(t.value=t.newValue,delete t.newValue,t.broadcast())})},module.exports=stream;
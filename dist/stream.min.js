function toArray(t){return Array.prototype.slice.apply(t)}function access(t){if("."!==t[0])throw new Error("invalid",t);var e=t.slice(1);return function(t){return t[e]}}function Stream(t){this.id=stream.nextId++,this.parents=[],this.children=[],this.listeners=[],this.value=void 0,this.updater=function(){},this.f=null,void 0!==t&&this.update(t)}function mapUpdater(t){this.newValue=this.f(t.newValue)}function filterUpdater(t){this.f(t.newValue)&&(this.newValue=t.newValue)}function uniqUpdater(t){this.value!==t.newValue&&(this.newValue=t.newValue)}function reduceUpdater(t){this.newValue=void 0!==this.value?this.f(this.value,t.newValue):t.newValue}function rewireUpdater(t){this.newValue=t.newValue}function masterUpdater(){this.newValue=mostRecentValue(this.master)}function hasNewValue(t){return t.hasOwnProperty("newValue")}function mostRecentValue(t){return t.hasOwnProperty("newValue")?t.newValue:t.value}function combine2Updater(t,e){this.newValue=this.f(mostRecentValue(t),mostRecentValue(e))}function combine3Updater(t,e,n){this.newValue=this.f(mostRecentValue(t),mostRecentValue(e),mostRecentValue(n))}function combineUpdater(){var t=this.parents.map(mostRecentValue);this.newValue=this.f.apply(null,t)}function merge2Updater(t,e){hasNewValue(t)&&(this.newValue=t.newValue),hasNewValue(e)&&(this.newValue=e.newValue)}function mergeUpdater(){for(var t=0,e=arguments.length;e>t;t++)hasNewValue(arguments[t])&&(this.newValue=arguments[t].newValue)}function keys(t){if(Object.keys)return Object.keys(t);var e=[];for(var n in t)t.hasOwnProperty(n)&&e.push(n);return e}function find(t,e){for(var n=0,r=t.length;r>n;n++){var a=t[n];if(e(a))return a}}function deferNextTick(t){function e(){n||t()}var n=!1;return process.nextTick(e),function(){n=!0}}function deferTimeout(t){var e=setTimeout(t);return function(){clearTimeout(e)}}function Transaction(){var t=this;stream.autoCommit&&(this.cancel=defer(function(){t.commit()})),this.actions=[]}function UpdateAction(t,e){this.stream=t,this.value=e}function EndAction(t){this.stream=t}function updateOrder(t){function e(t){allNodes.hasOwnProperty(t.id)||(allNodes[t.id]=t,t.children.forEach(function(t){parentCounts[t.id]=(parentCounts[t.id]||0)+1,e(t)}))}function n(t){var e=allNodes[t];e.children.forEach(function(t){parentCounts[t.id]--}),delete parentCounts[t],delete allNodes[t],nodesToUpdate.push(e)}for(parentCounts={},allNodes={},nodesToUpdate=[],t.forEach(function(t){parentCounts[t.id]=0,e(t)});;){var r=keys(parentCounts);if(0===r.length)break;var a=find(r,function(t){return 0===parentCounts[t]});n(a)}return nodesToUpdate}var log=console.log.bind(console);Stream.prototype.withInitialValue=function(t){return this.value=t,this},Stream.prototype.broadcast=function(){for(var t=0,e=this.listeners.length;e>t;t++)this.listeners[t].call(this,this.value)},Stream.prototype.forEach=function(t){return this.listeners.push(t),this},Stream.prototype.update=function(t){return stream.transaction().update(this,t),this},Stream.prototype.end=function(){return stream.withinCommit&&this.cancelTransactions(),stream.transaction().end(this),this},Stream.prototype.ended=function(){return this.endStream&&void 0!==mostRecentValue(this.endStream)},Stream.prototype.map=function(t){return stream.link(this,stream(),mapUpdater,t).linkEnds(this)},Stream.prototype.filter=function(t){return stream.link(this,stream(),filterUpdater,t)},Stream.prototype.uniq=function(){return stream.link(this,stream(),uniqUpdater)},Stream.prototype.reduce=function(t,e){return stream.link(this,stream().withInitialValue(e),reduceUpdater,t).linkEnds(this)},Stream.prototype.collect=function(){return this.reduce(function(t,e){return t.concat(e)},[])},Stream.prototype.rewire=function(t){for(var e=0,n=this.parents.length;n>e;e++){var r=this.parents[e];r.children.splice(r.children.indexOf(this))}return stream.link(t,this,rewireUpdater)},Stream.prototype.linkEnds=function(t){return stream.link(t.ends(),this.ends(),masterUpdater),this},Stream.prototype.toString=function(){function t(t,e){void 0!==e&&(n+=", "+t+": "+e)}function e(e,n){t(e,"["+n.map(function(t){return"s"+t.id}).join(", ")+"]")}var n="[Stream s"+this.id;return t("value",this.value),t("newValue",this.newValue),t("state",JSON.stringify(this.state)),e("parents",this.parents),e("children",this.children),n+"]"},Stream.prototype.inspect=function(){return this.toString()},Stream.prototype.log=function(t){return this.forEach(t?function(e){console.log(t,e)}:function(t){console.log(t)})},Stream.prototype.tick=function(){return stream.transaction().commit(),this},Stream.prototype.cancelTransactions=function(){var t=stream.transaction(),e=this;t.actions=t.actions.filter(function(t){return t.stream!==e})},Stream.prototype.ends=function(){return this.endStream||(this.endStream=stream(),this.endStream.master=this,this.endStream.ends=function(){throw new Error("Don't call .ends() of an .ends(), you silly")}),this.endStream},Stream.prototype.onEnd=function(t){this.ends().forEach(t)};var stream=function(t){return new Stream(t)};stream.autoCommit=!0,stream.withinCommit=!1,stream.nextId=1,stream.transaction=function(){return stream.tx||(stream.tx=new Transaction)},stream.tick=function(){return stream.transaction().commit(),stream},stream.from=function(t){return"string"==typeof t?stream.fromString(t):t instanceof Array?stream.fromArray(t):stream.fromValues.apply(stream,arguments)},stream.fromArray=function(t){var e=stream();return e.rest=t.slice(),e.next=function(){return this.rest.length?this.update(this.rest.shift()):this.end(),this},e.next(),e.forEach(e.next)},stream.fromRange=function(t,e,n){var r=stream();return r.state={current:t,end:e||1/0,step:n||1},r.next=function(){var t=this.state;t.current+=t.step,t.current<=t.end?this.update(t.current):this.end()},r.update(t),r.forEach(r.next)},stream.fromValues=function(){var t=Array.prototype.slice.call(arguments);return stream.fromArray.call(stream,t)},stream.fromString=function(t){return stream.fromArray(t.split(""))},stream.link=function(t,e,n,r){t instanceof Stream&&(t=[t]);for(var a=0,i=t.length;i>a;a++)t[a].children.push(e);return e.parents=t,e.updater=n,e.f=r||null,e},stream.speedtest=function(){function t(t){n=new Date;var e=stream.fromRange(0,r);e.onEnd(t)}function e(t){n=new Date;var e=stream.fromRange(0,r),a=e.reduce(function(t){return t+1},0),i=a.map(function(t){return 2*t});i.onEnd(t)}var n,r=5e3,a=function(t){return function(){var e=new Date-n,a=r/e*1e3;a=String(a).replace(/(\.\d).*/,"$1"),console.log(t+":",a,"iterations / s")}};t(a("simple")),setTimeout(function(){e(a("counter"))},1e3)},stream.combine=function(){var t=toArray(arguments),e=t.pop(),n=2===t.length?combine2Updater:3===t.length?combine3Updater:combineUpdater;return stream.link(t,stream(),n,e)},stream.merge=function(){var t=toArray(arguments),e=2===t.length?merge2Updater:mergeUpdater;return stream.link(t,stream(),e)},stream.zip=function(){var t=toArray(arguments);return t.push(Array),stream.combine.apply(null,t)},stream.util={},stream.util.identity=function(t){return t},stream.util.plus=function(t,e){return t+e},stream.util.inc=function(t){return t+1},stream.util.isEven=function(t){return!(t%2)},stream.util.isOdd=function(t){return!!(t%2)},stream.util.log=console.log.bind(console),stream.util.logPrefix=function(t){return function(){var e=toArray(arguments);e.unshift(t),console.log.apply(console,e)}};var defer="undefined"!=typeof process&&process.nextTick?deferNextTick:deferTimeout;UpdateAction.prototype.perform=function(){if(this.stream.ended())throw new Error("cannot update ended stream");this.stream.newValue=this.value},UpdateAction.prototype.toString=UpdateAction.prototype.inspect=function(){return"update(s"+this.stream.id+", "+this.value+")"},EndAction.prototype.perform=function(){var t=this.stream;t.endStream&&t.endStream.update(mostRecentValue(t))},EndAction.prototype.toString=EndAction.prototype.inspect=function(){return"end(s"+this.stream.id+")"},Transaction.prototype.update=function(t,e){this.actions.push(new UpdateAction(t,e))},Transaction.prototype.end=function(t){this.actions.push(new EndAction(t))},Transaction.prototype.commit=function(){stream.withinCommit=!0;try{this.cancel&&this.cancel();for(var t={},e=[],n=0;n<this.actions.length;n++){var r=this.actions[n];r.perform();var a=r.stream;r instanceof UpdateAction&&(t[a.id]||(e.push(a),t[a.id]=!0))}stream.tx===this&&delete stream.tx;var i=updateOrder(e);i.forEach(function(t){t.updater.apply(t,t.parents)}),i.forEach(function(t){hasNewValue(t)&&(t.value=t.newValue,delete t.newValue,t.broadcast())})}finally{stream.tx===this&&delete stream.tx,stream.withinCommit=!1}},module.exports=stream;
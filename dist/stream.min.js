function toArray(t){return Array.prototype.slice.apply(t)}function Stream(t){this.listeners=[],this.children=[],this.value=void 0,this.id=stream.nextId++,void 0!==t&&this.set(t)}function depends(){for(var t=arguments.length,e=arguments[t-2],n=arguments[t-1],r=0;t-2>r;r++)arguments[r].children.push(e);return e.f=n,e}function map(t,e){return depends(t,stream(),function(){this.newValue=e(t.newValue)})}function filter(t,e){return depends(t,stream(),function(){e(t.newValue)&&(this.newValue=t.newValue)})}function uniq(t){return depends(t,stream(),function(){this.value!==t.newValue&&(this.newValue=t.newValue)})}function reduce(t,e){return depends(t,stream(),function(){this.newValue=null!=this.value?e(this.value,t.newValue):t.newValue})}function hasNewValue(t){return t.hasOwnProperty("newValue")}function mostRecentValue(t){return t.hasOwnProperty("newValue")?t.newValue:t.value}function combine(){var t=toArray(arguments),e=t.pop(),n=t.concat([stream(),function(){this.newValue=e.apply(null,t.map(mostRecentValue))}]);return depends.apply(null,n)}function merge(){var t=toArray(arguments),e=t.concat([stream(),function(){for(var e=this,n=0,r=t.length;r>n;n++)hasNewValue(t[n])&&(e.newValue=t[n].newValue)}]);return depends.apply(null,e)}function keys(t){if(Object.keys)return Object.keys(t);var e=[];for(var n in t)t.hasOwnProperty(n)&&e.push(n);return e}function find(t,e){for(var n=0,r=t.length;r>n;n++){{t[n]}if(e(t[n]))return t[n]}}function defer(t){function e(){n||t()}var n=!1;return process.nextTick(e),function(){n=!0}}function Transaction(){var t=this;this.cancel=defer(function(){t.commit()}),this.ops=[]}function updateOrder(t){function e(t){allNodes.hasOwnProperty(t.id)||(allNodes[t.id]=t,t.children.forEach(function(t){parentCounts[t.id]=(parentCounts[t.id]||0)+1,e(t)}))}function n(t){var e=allNodes[t];e.children.forEach(function(t){parentCounts[t.id]--}),delete parentCounts[t],delete allNodes[t],nodesToUpdate.push(e)}for(parentCounts={},allNodes={},nodesToUpdate=[],t.forEach(function(t){parentCounts[t.id]=0,e(t)});;){var r=keys(parentCounts);if(0===r.length)break;var a=find(r,function(t){return 0===parentCounts[t]});n(a)}return nodesToUpdate}Stream.prototype={broadcast:function(){for(var t=0,e=this.listeners.length;e>t;t++)this.listeners[t](this.value)},forEach:function(t){return this.listeners.push(t),this},set:function(t,e){var n=this;if(e)return setTimeout(function(){var e=stream.transaction();e.set(n,t)},e),this;var r=stream.transaction();return r.set(n,t),this},map:function(t){return map(this,t)},filter:function(t){return filter(this,t)},uniq:function(){return uniq(this)},reduce:function(t){return reduce(this,t)},toString:function(){return"stream("+this.value+", id: "+this.id+")"},commit:function(){return stream.transaction().commit(),this},f:function(){}};var stream=function(t){return new Stream(t)};stream.nextId=0,stream.transaction=function(){return stream.tx||(stream.tx=new Transaction)},stream.fromArray=function(t){var e=stream(),n=function(){t.length&&(e.set(t.shift()),defer(n))};return n(),e},stream.fromValues=function(){var t=Array.prototype.slice.call(arguments);return stream.fromArray.call(stream,t)},stream.fromString=function(t){return stream.fromArray(t.split(""))},stream.combine=combine,stream.merge=merge,stream.zip=function(){var t=toArray(arguments);return t.push(Array),stream.combine.apply(null,t)},Transaction.prototype.set=function(t,e){this.ops.push([t,e])},Transaction.prototype.commit=function(){this.cancel&&this.cancel(),stream.tx===this&&delete stream.tx;for(var t={},e=[],n=0,r=this.ops.length;r>n;n++){var a=this.ops[n],s=a[0];s.newValue=a[1],t[s.id]||(e.push(s),t[s.id]=!0)}var u=updateOrder(e);u.forEach(function(t){t.f()}),u.forEach(function(t){hasNewValue(t)&&(t.value=t.newValue,delete t.newValue,t.broadcast())})},module.exports=stream;
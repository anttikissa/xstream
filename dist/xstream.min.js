function assert(t){if(!t)throw new Error("assert failed")}function assertType(t,e){if(typeof t!==e)throw new Error("wrong type")}function nop(){}function alwaysTrue(){return!0}function copyArray(t){return Array.prototype.slice.apply(t)}function Stream(t){this.id=Stream.nextId++,this.value=void 0,this.parents=[],this.children=[],this.listeners=[],this.updater=nop,void 0!==t&&this.update(t)}function stream(t){return new Stream(t)}function CyclicalDependencyError(t){Error.call(this,"Cyclical dependency"),this.path=t}function link(t,e,n,r){t instanceof Stream&&(t=[t]);for(var a=0,i=t.length;i>a;a++)t[a].children.push(e);return e.parents=t,e.updater=n,e.f=r||null,e}function mapUpdater(t){this.newValue=this.f(t.newValue)}function filterUpdater(t){this.f(t.newValue)&&(this.newValue=t.newValue)}function uniqUpdater(t){this.value!==t.newValue&&(this.newValue=t.newValue)}function takeUpdater(t){return this.state--<=0?this.end():void(this.newValue=t.newValue)}function skipUpdater(t){return this.state>0?void this.state--:void(this.newValue=t.newValue)}function slidingWindowUpdater(t){for(this.newValue=this.value.concat(t.newValue);this.newValue.length>this.state;)this.newValue.shift()}function reduceUpdater(t){this.newValue=void 0!==this.value?this.f(this.value,t.newValue):t.newValue}function rewireUpdater(t){this.newValue=t.newValue}function masterUpdater(){this.newValue=mostRecentValue(this.master)}function forUpdater(){return this.ended()?void 0:(this.newValue=this.f(),this.ended()?this.end():void stream.ticks.update())}function hasValue(t){return void 0!==mostRecentValue(t)}function hasNewValue(t){return t.hasOwnProperty("newValue")}function mostRecentValue(t){return t.hasOwnProperty("newValue")?t.newValue:t.value}function combine2Updater(t,e){this.newValue=this.f(mostRecentValue(t),mostRecentValue(e))}function combine3Updater(t,e,n){this.newValue=this.f(mostRecentValue(t),mostRecentValue(e),mostRecentValue(n))}function combineUpdater(){var t=this.parents.map(mostRecentValue);this.newValue=this.f.apply(null,t)}function combineWhenAll2Updater(t,e){hasValue(t)&&hasValue(e)&&(this.newValue=this.f(mostRecentValue(t),mostRecentValue(e)))}function combineWhenAll3Updater(t,e,n){hasValue(t)&&hasValue(e)&&hasValue(n)&&(this.newValue=this.f(mostRecentValue(t),mostRecentValue(e),mostRecentValue(n)))}function combineWhenAllUpdater(){if(this.parents.every(hasValue)){var t=this.parents.map(mostRecentValue);this.newValue=this.f.apply(null,t)}}function merge2Updater(t,e){hasNewValue(t)&&(this.newValue=t.newValue),hasNewValue(e)&&(this.newValue=e.newValue)}function mergeUpdater(){for(var t=0,e=arguments.length;e>t;t++)hasNewValue(arguments[t])&&(this.newValue=arguments[t].newValue)}function find(t,e){for(var n=0,r=t.length;r>n;n++){var a=t[n];if(e(a))return a}}function deferNextTick(t){function e(){n||t()}var n=!1;return process.nextTick(e),function(){n=!0}}function deferTimeout(t){var e=setTimeout(t);return function(){clearTimeout(e)}}function Transaction(){var t=this;stream.autoCommit&&(this.cancel=defer(function(){t.commit()})),this.actions=[]}function UpdateAction(t,e){this.stream=t,this.value=e}function EndAction(t){this.stream=t}function updateOrder(t){function e(t){allNodes.hasOwnProperty(t.id)||(allNodes[t.id]=t,t.children.forEach(function(t){parentCounts[t.id]=(parentCounts[t.id]||0)+1,e(t)}))}function n(t){assert(t);var e=allNodes[t];e.children.forEach(function(t){parentCounts[t.id]--}),delete parentCounts[t],delete allNodes[t],nodesToUpdate.push(e)}for(parentCounts={},allNodes={},nodesToUpdate=[],t.forEach(function(t){e(t)}),t.forEach(function(t){void 0===parentCounts[t.id]&&(parentCounts[t.id]=0)});;){var r=Object.keys(parentCounts);if(0===r.length)break;var a=find(r,function(t){return 0===parentCounts[t]});n(a)}return nodesToUpdate}var log=console.log.bind(console);Stream.nextId=0,module.exports=stream,stream.Stream=Stream,Stream.prototype.name=function(t){return this._name=t,this},Stream.prototype.withInitialValue=function(t){return this.value=t,this},Stream.prototype.forEach=function(t){return this.listeners.push(t),this},Stream.prototype.broadcast=function(){for(var t=0,e=this.listeners.length;e>t;t++)this.listeners[t].call(this,this.value)},stream.CyclicalDependencyError=CyclicalDependencyError,Stream.prototype.ensureNoCyclicalDependencies=function(){function t(r){if(e.length&&r.id===n.id)throw new CyclicalDependencyError(e);e.push(r),r.parents.forEach(function(e){t(e)}),e.pop()}var e=[],n=this;return t(this),this},Stream.prototype.pull=function(){return this.updater.apply(this,this.parents),void 0!==this.newValue&&(this.update(this.newValue),delete this.newValue),this},Stream.prototype.toString=function(){function t(t,e){void 0!==e&&(n+=", "+t+": "+e)}function e(e,n){t(e,"["+n.map(function(t){return"s"+t.id}).join(", ")+"]")}var n="[Stream s"+this.id;return t("value",this.value),t("name",this._name),t("newValue",this.newValue),t("state",JSON.stringify(this.state)),e("parents",this.parents),e("children",this.children),n+"]"},Stream.prototype.inspect=function(){return this.toString()},Stream.prototype.log=function(t){return this.forEach(t?function(e){console.log(t,e)}:function(t){console.log(t)})},stream.link=link,Stream.prototype.update=function(t){return stream.transaction().update(this,t),this},Stream.prototype.end=function(){return stream.withinCommit&&this.cancelTransactions(),stream.transaction().end(this),this},Stream.prototype.ended=function(){return!!this.endStream&&void 0!==mostRecentValue(this.endStream)},Stream.prototype.map=function(t){return stream.link(this,stream(),mapUpdater,t).linkEnds(this)},Stream.prototype.filter=function(t){return stream.link(this,stream(),filterUpdater,t)},Stream.prototype.uniq=function(){return stream.link(this,stream(),uniqUpdater)},Stream.prototype.withState=function(t){return this.state=t,this},Stream.prototype.take=function(t){return stream.link(this,stream().withState(t),takeUpdater).linkEnds(this)},Stream.prototype.skip=function(t){return stream.link(this,stream().withState(t),skipUpdater).linkEnds(this)},Stream.prototype.leave=function(t){var e=stream();return this.slidingWindow(t).onEnd(function(t){e.rewire(stream.fromArray(t))}),e},Stream.prototype.slidingWindow=function(t){return stream.link(this,stream().withState(t).withInitialValue([]),slidingWindowUpdater).linkEnds(this)},Stream.prototype.slice=function(t,e){return void 0===e?this.skip(t):this.skip(t).take(e-t)},Stream.prototype.reduce=function(t,e){return stream.link(this,stream().withInitialValue(e),reduceUpdater,t).linkEnds(this)},Stream.prototype.collect=function(){return this.reduce(function(t,e){return t.concat(e)},[])},Stream.prototype.removeChild=function(t){assert(-1!==this.children.indexOf(t)),this.children.splice(this.children.indexOf(t),1)},Stream.prototype.detachFromParents=function(){for(var t=0,e=this.parents.length;e>t;t++)this.parents[t].removeChild(this);this.parents=[]},Stream.prototype.rewire=function(t){for(var e=0,n=this.parents.length;n>e;e++){var r=this.parents[e];r.removeChild(this)}return stream.link(t,this,rewireUpdater).ensureNoCyclicalDependencies().linkEnds(t)},Stream.prototype.linkEnds=function(t){return stream.link(t.ends(),this.ends(),masterUpdater),this},Stream.prototype.tick=function(t){return stream.tick(t),this},Stream.prototype.cancelTransactions=function(){var t=stream.transaction(),e=this;t.actions=t.actions.filter(function(t){return t.stream!==e})},Stream.prototype.ends=function(){return this.endStream||(this.endStream=stream(),this.endStream.master=this,this.endStream.ends=function(){throw new Error("Don't call .ends() of an .ends(), you silly")}),this.endStream},Stream.prototype.onEnd=function(t){this.ends().forEach(t.bind(this))},Stream.prototype.endWhen=function(t){return this.forEach(function(e){e===t&&this.end()}),this},stream.autoCommit=!0,stream.withinCommit=!1,stream.nextTick=0,stream.ticks=stream(),stream.ticks.updater=function(){this.newValue=stream.nextTick++},stream.transaction=function(){return stream.tx||(stream.tx=new Transaction)},stream.tick=function(t){for(t=t||1;t--;)stream.transaction().commit();return stream},stream.from=function(t){if(1===arguments.length){if("string"==typeof t)return stream.fromString(t);if(t instanceof Array)return stream.fromArray(t)}return stream.fromValues.apply(stream,arguments)},stream.for=function(t,e,n){var r=stream.link(stream.ticks,stream().withState(t),forUpdater,n);return e&&(r.ended=function(){return this.endStream&&void 0!==mostRecentValue(this.endStream)?!0:!e.apply(this)}),r.ended()?r.end():r.update(),r},stream.loop=function(t,e){return stream.for(t,alwaysTrue,e)},stream.count=function(t){return stream.loop(t||0,function(){return this.state++})},stream.fromArray=function(t){return stream.for(copyArray(t),function(){return this.state.length},function(){return this.state.shift()})},stream.fromRange=function(t,e,n){return e=void 0!==e?e:1/0,n=n||1,stream.for({current:t,end:e,step:n},function(){return this.state.current<=this.state.end},function(){var t=this.state.current;return this.state.current+=this.state.step,t})},stream.fromValues=function(){var t=Array.prototype.slice.call(arguments);return stream.fromArray.call(stream,t)},stream.fromString=function(t){return stream.fromArray(t.split(""))},stream.speedtest=function(){function t(t){n=new Date;var e=stream.fromRange(0,r);e.onEnd(t)}function e(t){n=new Date;var e=stream.fromRange(0,r),a=e.reduce(function(t){return t+1},0),i=a.map(function(t){return 2*t});i.onEnd(t)}var n,r=5e3,a=function(t){return function(){var e=new Date-n,a=r/e*1e3;a=String(a).replace(/(\.\d).*/,"$1"),console.log(t+":",a,"iterations / s")}};t(a("simple")),setTimeout(function(){e(a("counter"))},1e3)},stream.combine=function(){var t=copyArray(arguments),e=t.pop(),n=2===t.length?combine2Updater:3===t.length?combine3Updater:combineUpdater;return stream.link(t,stream(),n,e)},stream.combineWhenAll=function(){var t=copyArray(arguments),e=t.pop(),n=2===t.length?combineWhenAllUpdater:3===t.length?combineWhenAllUpdater:combineWhenAllUpdater;return stream.link(t,stream(),n,e)},stream.merge=function(){var t=copyArray(arguments),e=2===t.length?merge2Updater:mergeUpdater;return stream.link(t,stream(),e)},stream.zip=function(){var t=copyArray(arguments);return t.push(Array),stream.combine.apply(null,t)},stream.util={},stream.util.identity=function(t){return t},stream.util.not=function(t){return function(e){return!t(e)}},stream.util.plus=function(t,e){return t+e},stream.util.inc=function(t){return t+1},stream.util.isEven=function(t){return!(t%2)},stream.util.isOdd=function(t){return!!(t%2)};var defer="undefined"!=typeof process&&process.nextTick?deferNextTick:deferTimeout;UpdateAction.prototype.preUpdate=function(){if(this.stream.ended())throw new Error("cannot update ended stream");return this.stream.newValue=this.value,!0},UpdateAction.prototype.postUpdate=nop,UpdateAction.prototype.toString=UpdateAction.prototype.inspect=function(){return"update(s"+this.stream.id+", "+this.value+")"},EndAction.prototype.preUpdate=function(){var t=this.stream;t.ends().update(mostRecentValue(t))},EndAction.prototype.postUpdate=function(){this.stream.detachFromParents()},EndAction.prototype.toString=EndAction.prototype.inspect=function(){return"end(s"+this.stream.id+")"},Transaction.prototype.update=function(t,e){this.actions.push(new UpdateAction(t,e))},Transaction.prototype.end=function(t){this.actions.push(new EndAction(t))},Transaction.prototype.commit=function(){stream.withinCommit=!0,stream.ticks.update();try{this.cancel&&this.cancel();for(var t={},e=[],n=0;n<this.actions.length;n++){var r=this.actions[n];if(r.preUpdate()){var a=r.stream;t[a.id]||(e.push(a),t[a.id]=!0)}}stream.tx===this&&delete stream.tx;var i=updateOrder(e);i.forEach(function(t){(t.parents.some(hasNewValue)||t===stream.ticks)&&t.updater.apply(t,t.parents)}),i.forEach(function(t){hasNewValue(t)&&(t.value=t.newValue,delete t.newValue,t.broadcast())});for(var n=0;n<this.actions.length;n++){var r=this.actions[n];r.postUpdate()}}finally{stream.tx===this&&delete stream.tx,stream.withinCommit=!1}};
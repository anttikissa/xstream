function assert(t){if(!t)throw new Error("assert failed")}function assertType(t,e){if(typeof t!==e)throw new Error("wrong type")}function nop(){}function alwaysTrue(){return!0}function copyArray(t){return Array.prototype.slice.apply(t)}function hasValue(t){return void 0!==mostRecentValue(t)}function hasNewValue(t){return t.hasOwnProperty("newValue")}function mostRecentValue(t){return t.hasOwnProperty("newValue")?t.newValue:t.value}function find(t,e){for(var n=0,r=t.length;r>n;n++){var i=t[n];if(e(i))return i}}function deferNextTick(t){function e(){n||t()}var n=!1;return process.nextTick(e),function(){n=!0}}function deferTimeout(t){var e=setTimeout(t);return function(){clearTimeout(e)}}function Stream(t){this.id=Stream.nextId++,this.value=void 0,this.parents=[],this.children=[],this.listeners=[],this.updater=nop,void 0!==t&&this.set(t)}function stream(t){return new Stream(t)}function SetAction(t,e){this.stream=t,this.value=e}function UpdateAction(t){this.stream=t}function CyclicalDependencyError(t){Error.call(this,"Cyclical dependency"),this.path=t}function rewireUpdater(t){this.newValue=t.newValue}function masterUpdater(){this.newValue=mostRecentValue(this.master)}function mapUpdater(t){this.newValue=this.f(t.newValue)}function filterUpdater(t){this.f(t.newValue)&&(this.newValue=t.newValue)}function uniqUpdater(t){this.value!==t.newValue&&(this.newValue=t.newValue)}function takeUpdater(t){return this.state--<=0?this.end():void(this.newValue=t.newValue)}function skipUpdater(t){return this.state>0?void this.state--:void(this.newValue=t.newValue)}function slidingWindowUpdater(t){for(this.newValue=this.value.concat(t.newValue);this.newValue.length>this.state;)this.newValue.shift()}function reduceUpdater(t){this.newValue=void 0!==this.value?this.f(this.value,t.newValue):t.newValue}function EndAction(t){this.stream=t}function updateOrder(t){function e(t){allNodes.hasOwnProperty(t.id)||(allNodes[t.id]=t,t.children.forEach(function(t){parentCounts[t.id]=(parentCounts[t.id]||0)+1,e(t)}))}function n(t){assert(t);var e=allNodes[t];e.children.forEach(function(t){parentCounts[t.id]--}),delete parentCounts[t],delete allNodes[t],nodesToUpdate.push(e)}for(parentCounts={},allNodes={},nodesToUpdate=[],t.forEach(function(t){e(t)}),t.forEach(function(t){void 0===parentCounts[t.id]&&(parentCounts[t.id]=0)});;){var r=Object.keys(parentCounts);if(0===r.length)break;var i=find(r,function(t){return assert(parentCounts[t]>=0),0===parentCounts[t]});n(i)}return nodesToUpdate}function tick(){console.realLog("1 update queue",stream.updateQueue.length),stream.ticks.update(),console.realLog("2 update queue",stream.updateQueue.length);try{stream.cancelDeferredTick&&(stream.cancelDeferredTick(),delete stream.cancelDeferredTick);for(var t={},e=[],n=stream.actionQueue,r=0;r<n.length;r++){var i=n[r];i.preUpdate();for(var a=i.dependencies(),s=0,o=a.length;o>s;s++){var u=a[s];t[u.id]||(e.push(u),t[u.id]=!0)}}var c=stream.updateQueue;console.realLog("3 update queue",c.length);for(var r=0;r<c.length;r++){var i=c[r],a=i.dependencies();console.realLog("action",i),console.realLog("deps",a);for(var s=0,o=a.length;o>s;s++){var u=a[s];t[u.id]||(e.push(u),t[u.id]=!0)}}console.realLog("updatedStreams",t)}finally{stream.actionQueue=[],stream.updateQueue=[]}var p=updateOrder(e);p.forEach(function(t){(t.parents.some(hasNewValue)||t===stream.ticks)&&t.updater.apply(t,t.parents)}),p.forEach(function(t){hasNewValue(t)&&(t.value=t.newValue,delete t.newValue,t.broadcast())});for(var r=0,o=n.length;o>r;r++){var i=n[r];i.postUpdate()}}function combine2Updater(t,e){this.newValue=this.f(mostRecentValue(t),mostRecentValue(e))}function combine3Updater(t,e,n){this.newValue=this.f(mostRecentValue(t),mostRecentValue(e),mostRecentValue(n))}function combineUpdater(){var t=this.parents.map(mostRecentValue);this.newValue=this.f.apply(null,t)}function combineWhenAll2Updater(t,e){hasValue(t)&&hasValue(e)&&(this.newValue=this.f(mostRecentValue(t),mostRecentValue(e)))}function combineWhenAll3Updater(t,e,n){hasValue(t)&&hasValue(e)&&hasValue(n)&&(this.newValue=this.f(mostRecentValue(t),mostRecentValue(e),mostRecentValue(n)))}function combineWhenAllUpdater(){if(this.parents.every(hasValue)){var t=this.parents.map(mostRecentValue);this.newValue=this.f.apply(null,t)}}function merge2Updater(t,e){hasNewValue(t)&&(this.newValue=t.newValue),hasNewValue(e)&&(this.newValue=e.newValue)}function mergeUpdater(){for(var t=0,e=arguments.length;e>t;t++)hasNewValue(arguments[t])&&(this.newValue=arguments[t].newValue)}function forUpdater(){return this.ended()?void 0:(this.newValue=this.f(),this.ended()?this.end():void stream.ticks.update())}var log=console.log.bind(console),defer="undefined"!=typeof process&&process.nextTick?deferNextTick:deferTimeout;Stream.nextId=0,module.exports=stream,stream.Stream=Stream,Stream.prototype.withInitialValue=function(t){return this.value=t,this},Stream.prototype.withState=function(t){return this.state=t,this},Stream.prototype.forEach=function(t){return this.listeners.push(t),this},Stream.prototype.broadcast=function(){for(var t=0,e=this.listeners.length;e>t;t++)this.listeners[t].call(this,this.value)},Stream.prototype.pull=function(){this.update()},Stream.prototype.withName=function(t){return this.name=t,this},Stream.prototype.log=function(t){return this.forEach(t?function(e){console.log(t,e)}:function(t){console.log(t)})},Stream.prototype.toString=function(){function t(t,e){void 0!==e&&(n+=", "+t+": "+e)}function e(e,n){t(e,"["+n.map(function(t){return"s"+t.id}).join(", ")+"]")}var n="[Stream s"+this.id;return t("value",this.value),t("name",this.name),t("newValue",this.newValue),t("state",JSON.stringify(this.state)),e("parents",this.parents),e("children",this.children),n+"]"},Stream.prototype.inspect=function(){return this.toString()},Stream.prototype.addChild=function(t){this.children.push(t)},Stream.prototype.removeChild=function(t){assert(-1!==this.children.indexOf(t)),this.children.splice(this.children.indexOf(t),1)},Stream.prototype.link=function(t,e,n){assert(0===this.parents.length),t instanceof Stream&&(t=[t]);for(var r=0,i=t.length;i>r;r++)t[r].addChild(this);return this.parents=t,this.updater=e,this.f=n||null,this},Stream.prototype.unlink=function(){for(var t=0,e=this.parents.length;e>t;t++)this.parents[t].removeChild(this);this.parents=[]},SetAction.prototype.dependencies=function(){return[this.stream]},SetAction.prototype.preUpdate=function(){if(this.stream.ended())throw new Error("cannot set ended stream's value");this.stream.newValue=this.value},SetAction.prototype.postUpdate=nop,SetAction.prototype.toString=SetAction.prototype.inspect=function(){return"set(s"+this.stream.id+", "+this.value+")"},Stream.prototype.set=function(t){if(this.updater!==nop&&this.updater!==masterUpdater)throw console.realLog("this.updater",this.updater),new Error("fu");return stream.scheduleAction(new SetAction(this,t)),this},UpdateAction.prototype.preUpdate=nop,UpdateAction.prototype.dependencies=function(){function t(n){e.push(n),n.parents.forEach(function(e){t(e)})}var e=[];return t(this.stream),e},UpdateAction.prototype.postUpdate=nop,UpdateAction.prototype.toString=UpdateAction.prototype.inspect=function(){return"update(s"+this.stream.id+")"},Stream.prototype.update=function(){return stream.scheduleUpdate(new UpdateAction(this)),this},Stream.prototype.end=function(){return stream.scheduleAction(new EndAction(this)),this},Stream.prototype.ended=function(){return!!this.endStream&&void 0!==mostRecentValue(this.endStream)},stream.CyclicalDependencyError=CyclicalDependencyError,Stream.prototype.ensureNoCyclicalDependencies=function(){function t(r){if(e.length&&r.id===n.id)throw new CyclicalDependencyError(e);e.push(r),r.parents.forEach(function(e){t(e)}),e.pop()}var e=[],n=this;return t(this),this},Stream.prototype.rewire=function(t){return this.unlink(),this.link(t,rewireUpdater).ensureNoCyclicalDependencies().linkEnds(t)},Stream.prototype.linkEnds=function(t){return this.ends().unlink(),this.ends().link(t.ends(),masterUpdater),this},Stream.prototype.tick=function(t){return stream.tick(t),this},Stream.prototype.ends=function(){return this.endStream||(this.endStream=stream(),this.endStream.master=this,this.endStream.ends=function(){throw new Error("Don't call .ends() of an .ends(), you silly")}),this.endStream},Stream.prototype.onEnd=function(t){return this.ends().forEach(t.bind(this)),this},Stream.prototype.endWhen=function(t){return this.forEach(function(e){e===t&&this.end()}),this},Stream.prototype.map=function(t){return stream().link(this,mapUpdater,t).linkEnds(this)},Stream.prototype.filter=function(t){return stream().link(this,filterUpdater,t)},Stream.prototype.uniq=function(){return stream().link(this,uniqUpdater)},Stream.prototype.take=function(t){return stream().withState(t).link(this,takeUpdater).linkEnds(this)},Stream.prototype.skip=function(t){return stream().withState(t).link(this,skipUpdater).linkEnds(this)},Stream.prototype.leave=function(t){var e=stream();return this.slidingWindow(t).onEnd(function(t){e.rewire(stream.fromArray(t))}),e},Stream.prototype.slidingWindow=function(t){return stream().withState(t).withInitialValue([]).link(this,slidingWindowUpdater).linkEnds(this)},Stream.prototype.slice=function(t,e){return void 0===e?this.skip(t):this.skip(t).take(e-t)},Stream.prototype.reduce=function(t,e){return stream().withInitialValue(e).link(this,reduceUpdater,t).linkEnds(this)},Stream.prototype.collect=function(){return this.reduce(function(t,e){return t.concat(e)},[])},stream.ticks=stream().withState(0),stream.ticks.updater=function(){this.newValue=this.state++},stream.actionQueue=[],stream.updateQueue=[],stream.ensureDeferredTick=function(){stream.cancelDeferredTick||(stream.cancelDeferredTick=defer(tick))},stream.scheduleAction=function(t){stream.actionQueue.push(t),stream.ensureDeferredTick()},stream.scheduleUpdate=function(t){stream.updateQueue.push(t),stream.ensureDeferredTick()},EndAction.prototype.preUpdate=function(){var t=this.stream;t.ends().set(mostRecentValue(t))},EndAction.prototype.dependencies=function(){return[]},EndAction.prototype.postUpdate=function(){this.stream.unlink(),this.stream.listeners=[]},EndAction.prototype.toString=EndAction.prototype.inspect=function(){return"end(s"+this.stream.id+")"},stream.tick=function(t){for(void 0===t&&(t=1);t--;)tick()},stream.combine=function(){var t=copyArray(arguments),e=t.pop(),n=2===t.length?combine2Updater:3===t.length?combine3Updater:combineUpdater;return stream().link(t,n,e)},stream.combineWhenAll=function(){var t=copyArray(arguments),e=t.pop(),n=2===t.length?combineWhenAll2Updater:3===t.length?combineWhenAll3Updater:combineWhenAllUpdater;return stream().link(t,n,e)},stream.merge=function(){var t=copyArray(arguments),e=2===t.length?merge2Updater:mergeUpdater;return stream().link(t,e)},stream.zip=function(){var t=copyArray(arguments);return t.push(Array),stream.combine.apply(null,t)},stream.for=function(t,e,n){var r=stream().withState(t).link(stream.ticks,forUpdater,n);return e&&(r.ended=function(){return this.endStream&&void 0!==mostRecentValue(this.endStream)?!0:!e.apply(this)}),r.ended()?r.end():r.update(),r},stream.loop=function(t,e){return stream.for(t,alwaysTrue,e)},stream.count=function(t){return stream.loop(t||0,function(){return this.state++})},stream.fromArray=function(t){return stream.for(copyArray(t),function(){return this.state.length},function(){return this.state.shift()})},stream.fromRange=function(t,e,n){return e=void 0!==e?e:1/0,n=n||1,stream.for({current:t,end:e,step:n},function(){return this.state.current<=this.state.end},function(){var t=this.state.current;return this.state.current+=this.state.step,t})},stream.fromValues=function(){return stream.fromArray.call(stream,arguments)},stream.fromString=function(t){return stream.fromArray(t.split(""))},stream.from=function(t){if(1===arguments.length){if("string"==typeof t)return stream.fromString(t);if(t instanceof Array)return stream.fromArray(t)}return stream.fromValues.apply(stream,arguments)},stream.speedtest=function(){function t(t){n=new Date;var e=stream.fromRange(0,r);e.onEnd(t)}function e(t){n=new Date;var e=stream.fromRange(0,r),i=e.reduce(function(t){return t+1},0),a=i.map(function(t){return 2*t});a.onEnd(t)}var n,r=5e3,i=function(t){return function(){var e=new Date-n,i=r/e*1e3;i=String(i).replace(/(\.\d).*/,"$1"),console.log(t+":",i,"iterations / s")}};t(i("simple")),setTimeout(function(){e(i("counter"))},1e3)},stream.util={},stream.util.identity=function(t){return t},stream.util.not=function(t){return function(e){return!t(e)}},stream.util.plus=function(t,e){return t+e},stream.util.inc=function(t){return t+1},stream.util.isEven=function(t){return!(t%2)},stream.util.isOdd=function(t){return!!(t%2)};
function plus(e,t){return e+t}function inc(e){return e+1}function isEven(e){return!(e%2)}function isOdd(e){return e%2}function nop(){}function contains(e,t){return-1!==e.indexOf(t)}function remove(e,t){assert(contains(e,t)),e.splice(e.indexOf(t),1)}function find(e,t){for(var r=0,s=e.length;s>r;r++){var a=e[r];if(t(a))return a}}function copyArray(e){return Array.prototype.slice.apply(e)}function hasValue(e){return void 0!==valueOf(e)}function hasNewValue(e){return e.hasOwnProperty("newValue")}function valueOf(e){return e.hasOwnProperty("newValue")?e.newValue:e.value}function deferNextTick(e){function t(){r||e()}var r=!1;return process.nextTick(t),function(){r=!0}}function deferTimeout(e){var t=setTimeout(e);return function(){clearTimeout(t)}}function terminate(){process.exit(1)}function assert(e,t,r){var s=r?3:2;if(!e){if(t){var a=new Error("assert failed: "+t);throw a.skipLines=s,a}var a=new Error("assert failed");throw a.skipLines=s,a}}function expect(e){var t=[e];contains(e,"; ")&&(t=e.split("; "));for(var r=0;r<t.length;r++){var s=t[r],a=consoleOutput.shift();assert("string"==typeof a,'expected "'+s+'", got no output',!0),assert(a===s,'expected "'+s+'", got "'+a+'"',!0)}}function expectNoOutput(){assert(0===consoleOutput.length,'expected no output, got "'+consoleOutput[0]+'"',!0)}function log(){console.log.apply(console.log,arguments)}function Stream(e){this.id=Stream.nextId++,this.value=e,this.children=[],this.parents=[],this.listeners=[]}function stream(e){return new Stream(e)}function updateOrder(e){function t(e){allNodes.hasOwnProperty(e.id)||(allNodes[e.id]=e,e.children.forEach(function(e){parentCounts[e.id]=(parentCounts[e.id]||0)+1,t(e)}))}function r(e){assert(e);var t=allNodes[e];t.children.forEach(function(e){parentCounts[e.id]--}),delete parentCounts[e],delete allNodes[e],nodesToUpdate.push(t)}for(parentCounts={},allNodes={},nodesToUpdate=[],e.forEach(function(e){t(e)}),e.forEach(function(e){void 0===parentCounts[e.id]&&(parentCounts[e.id]=0)});;){var s=Object.keys(parentCounts);if(0===s.length)break;var a=find(s,function(e){return assert(parentCounts[e]>=0),0===parentCounts[e]});r(a)}return nodesToUpdate}function collectTests(e,t,r){var s=1;for(var a in e){var n=r?r+"."+s:s,i=t?t+"."+a:a,o="Test "+n+": "+i,c=e[a];tests.push([o,c]),collectTests(e[a],i,n),s++}}function testAll(){function e(){var e=Date.now();log("Running",r,"tests took",e-s,"ms")}function t(){function r(){assert.type(stream.cancelDeferredTick,"undefined","test functions should not leave deferred .tick()s behind"),expectNoOutput(),defer(t)}var s=tests.shift();if(!s)return void e();var a=s[0],n=s[1];try{log(a+"\n"),1===n.length?n(r):(n(),r())}catch(i){log("Error:",i.message+"\n"),log(i.stack.split("\n").slice(i.skipLines||0).join("\n")),terminate()}}collectTests(test);var r=tests.length,s=Date.now();t()}var defer="undefined"!=typeof process&&process.nextTick?deferNextTick:deferTimeout;assert.eq=function(e,t,r){if(r=r?": "+r:"",e!==t){var s=new Error("assert failed"+r+": expected "+t+", got "+e);throw s.skipLines=2,s}},assert.type=function(e,t,r){var s,r=r?": "+r:"";if("string"==typeof t&&typeof e!==t&&(s="assert failed"+r+": expected type to be "+t+", was "+typeof e),"function"==typeof t&&(e instanceof t||(s="assert failed"+r+": expected "+e+" to be instanceof "+t.name)),s){var a=new Error(s);throw a.skipLines=2,a}},assert.throws=function(e){try{e()}catch(t){return}var r=e.toString().replace(/\/\/.*$/gm,"").replace(/\s+/g," "),t=new Error("assert failed: expected "+r+" to throw");throw t.skipLines=2,t};var consoleOutput=[];test={},Stream.nextId=1,test.Stream=function(){var e=new Stream;assert.type(e,"object"),assert.type(e,Stream),assert.eq(e.value,void 0),assert.eq(e.listeners.length,0),assert.eq(e.children.length,0),assert.eq(e.parents.length,0),assert.eq(new Stream(123).value,123);var t=(new Stream).id;assert.type(t,"number");var r=(new Stream).id;assert.type(r,"number")},module.exports=stream,test.stream=function(){assert(stream()instanceof Stream),assert.eq(stream(123).value,123)},Stream.prototype.set=function(e){return stream.streamsToUpdate.push(this),this.newValue=e,stream.ensureDeferredTick(),this},test.Stream.set=function(e){var t=stream(),r=t.set(1);assert.eq(t,r,"stream.set() should return the stream itself"),assert(contains(stream.streamsToUpdate,t)),assert.eq(t.value,void 0,"stream.value should be undefined before tick()"),stream.tick(),assert(!contains(stream.streamsToUpdate,t),"tick should clear stream.streamsToUpdate"),assert.eq(t.value,1,"stream.value should be set after tick()"),t.set(2),assert.eq(t.value,1,"s.set() should not set the value immediately"),defer(function(){assert.eq(t.value,2,"s.set() should set the value after the next tick"),e()})},Stream.prototype.broadcast=function(){for(var e=0,t=this.listeners.length;t>e;e++)this.listeners[e].call(this,this.value)},test.Stream.broadcast=function(){var e=stream(123);e.forEach(function(e){stream.log("first",e)}).forEach(function(e){stream.log("second",e)}),e.broadcast(),expect("first 123; second 123")},Stream.prototype.forEach=function(e){return this.listeners.push(e),this},test.Stream.forEach=function(){var e=stream();assert.eq(e,e.forEach(nop),".forEach should return the stream itself"),e.forEach(function(t){assert.eq(this,e,'listener should receive the stream in "this"'),stream.log("s",t)}),e.set(1),stream.tick(),expect("s 1"),stream(123).forEach(function(){assert(!1,".forEach functions should not be called without .set()")})},Stream.prototype.pull=function(){return this.parents.some(hasValue)&&this.update.apply(this,this.parents),hasNewValue(this)&&(this.value=this.newValue,delete this.newValue),this},test.Stream.pull=function(){var e=stream(123),t=stream();t.parents=[e],e.children=[t],t.update=function(e){this.newValue=valueOf(e)},assert.eq(t.value,void 0,"child shouldn't get a value automatically"),stream.tick(),assert.eq(t.value,void 0,"not even if stream.tick() happens"),t.pull(),assert.eq(t.value,123,"when it a child calls .pull(), it finally gets one"),e=stream(),t=stream(),t.parents=[e],e.children=[t],t.update=function(){throw new Error(".pull() should never call update() if there's no value")},t.pull()},Stream.prototype.addChild=function(e){this.children.push(e)},test.Stream.addChild=function(){var e=stream();assert.eq(e.children.length,0);var t=stream();e.addChild(t),assert.eq(e.children.length,1),assert.eq(e.children[0],t),e.addChild(t),assert.eq(e.children.length,2)},Stream.prototype.removeChild=function(e){remove(this.children,e)},test.Stream.removeChild=function(){var e=stream(),t=stream();e.addChild(stream()),e.addChild(t),e.addChild(stream()),assert.eq(e.children.length,3),assert(contains(e.children,t)),e.removeChild(t),assert.eq(e.children.length,2),assert(!contains(e.children,t)),e.addChild(stream()),e.addChild(t),e.addChild(stream()),e.addChild(t),e.addChild(stream()),assert.eq(e.children.length,7),e.removeChild(t),assert.eq(e.children.length,6),assert(contains(e.children,t)),e.removeChild(t),assert.eq(e.children.length,5),assert(!contains(e.children,t)),assert.throws(function(){e.removeChild(t)})},Stream.prototype.log=function(e){return this.forEach(e?function(t){stream.log(e,t)}:function(e){stream.log(e)})},test.Stream.log=function(){var e=stream().set(1);e.log(),stream.tick(),expect("1"),e.log("prefix"),e.set(2),stream.tick(),expect("2; prefix 2")},Stream.prototype.map=function(e){var t=stream();return t.f=e,t.update=function(e){this.newValue=this.f(valueOf(e))},t.parents=[this],this.children.push(t),t.pull(),t},test.Stream.map=function(){{var e=stream(),t=e.map(inc).log("s2");t.map(inc).log("s3")}e.set(1),stream.tick(),expect("s2 2; s3 3");var r=stream(1),s=r.map(inc);assert.eq(s.value,2,"if parent has a value, map() should pull it immediately");{var a=stream();a.map(function(){throw new Error("map() shouldn't try to pull its value if parent doesn't have it")})}},Stream.prototype.filter=function(e){var t=stream();return t.f=e,t.update=function(e){var t=valueOf(e);this.f(t)&&(this.newValue=t)},t.parents=[this],this.children.push(t),t.pull(),t},test.Stream.filter=function(){var e=stream();e.filter(isOdd).log(),e.set(1),stream.tick(),e.set(2),stream.tick(),e.set(3),stream.tick(),e.set(4),stream.tick(),e.set(5),stream.tick(),expect("1; 3; 5")},stream.log=function(){function e(e){return"string"==typeof e||"number"==typeof e?String(e):require("util").inspect(e)}var t=copyArray(arguments).map(e).join(" ");consoleOutput.push(t),console.log(t)},test.stream.log=function(){stream.log("hello"),expect("hello"),stream.log(123,[2,3,4],{x:"foo","y z":"bar"}),expect("123 [ 2, 3, 4 ] { x: 'foo', 'y z': 'bar' }")},stream.ensureDeferredTick=function(){stream.cancelDeferredTick||(stream.cancelDeferredTick=defer(stream.tick))},test.stream.ensureDeferredTick=function(){assert.type(stream.cancelDeferredTick,"undefined","there should be no deferred tick scheduled at the beginning of a test"),stream.ensureDeferredTick(),assert.type(stream.cancelDeferredTick,"function","ensureDeferredTick() should schedule a tick"),stream.ensureDeferredTick(),assert.type(stream.cancelDeferredTick,"function","even when called twice, although this does not test its semantics"),stream.tick(),assert.type(stream.cancelDeferredTick,"undefined","there is no scheduled tick at the end of the tick, since the test framework would yell otherwise")},stream.streamsToUpdate=[],stream.tick=function(e){stream.cancelDeferredTick&&(stream.cancelDeferredTick(),delete stream.cancelDeferredTick);var t=updateOrder(stream.streamsToUpdate);stream.streamsToUpdate=[];for(var r=0,s=t.length;s>r;r++){var a=t[r];a.parents.some(hasNewValue)&&a.update.apply(a,a.parents)}for(var r=0,s=t.length;s>r;r++){var a=t[r];hasNewValue(a)&&(a.value=a.newValue,delete a.newValue,a.broadcast())}e>1&&stream.tick(e-1)},test.stream.tick=function(){function e(e){this.set(e+1)}var t=stream();t.forEach(e),t.set(0),stream.tick(),assert.eq(t.value,0),stream.tick(),assert.eq(t.value,1),t.listeners=[],stream.tick(),t.set(0),t.forEach(e),stream.tick(),assert.eq(t.value,0),stream.tick(5),assert.eq(t.value,5),t.listeners=[],stream.tick()},stream.fromArray=function(e){var t=stream();return t.state=e,t.next=function(){var e=this.state.shift();void 0!==e&&this.set(e)},t.undo=function(e){this.state.unshift(e)},t.stop=function(){hasNewValue(this)&&(this.undo(this.newValue),delete this.newValue)},t.play=function(){this.next()},t.next(),t.forEach(t.next),t},test.stream.fromArray=function(){stream.fromArray([1,2,3,4]).log(),stream.tick(5),expect("1; 2; 3; 4")},test.stream.fromArray.stop=function(){var e=stream.fromArray([1,2,3,4,5]).log();e.forEach(function(t){3===t&&e.stop()}),stream.tick(5),expect("1; 2; 3")},test.stream.fromArray.play=function(){var e=stream.fromArray([1,2,3,4,5]).log();e.forEach(function(e){4==e&&this.stop()}),stream.tick(2),expect("1; 2"),e.stop(),e.play(),stream.tick(5),expect("3; 4"),e.play(),stream.tick(),expect("5")};var tests=[];process.env.XSTREAM_TEST&&testAll();
#!/usr/bin/env node
// vim: set filetype=javascript:

var maxTest = 13;

var fs = require('fs');

var args = process.argv.slice(2);

if (!args.length) {
	console.log('Usage: mktest file ...');
	process.exit(1);
}

console.log(args);

var testLines = [];

function push(line) {
	var actual = line || '';

	testLines.push(actual);
}

args.forEach(function(filename) {
	var testIdx = 0;

	testLines.push('// Tests from ' + filename + ':');

	var lines = fs.readFileSync(filename, 'utf8').split('\n');
	lines.pop();

	var prevLineType;
	var wasEmptyCodeLine = false;
	var wasEmptyCommentLine = false;
	var prevComment = [];
	function prepend(prefix) { return function(s) { return prefix + s; } }
	lines.forEach(function(line, idx) {
		idx = idx + 1;
		var indented = !!line.match(/^\t/);
		var followsCodeLine = prevLineType === 'code';
		var followsCommentLine = prevLineType !== 'code';
		var isEmpty = line.trim() === '';
		if (indented || (isEmpty && followsCodeLine)) {
			if (prevLineType !== 'code') {
				testIdx++;
				var testDescription = 'test ' + testIdx + ', line ' + idx +
					' ' + prevComment.join(' ').replace(/\'/g, '\\\'').
					trim().replace(/:$/, '');
				push();
				push('// test ' + testIdx + ', line ' + idx);
				testLines.push('//');
				prevComment.map(prepend('// ')).forEach(push);
				prevComment = [];
				push('(function() {');
				push("\tglobal.console.log('" + testDescription + "');");
			}
			if (testIdx >= maxTest) {
				push('//' + line);
				prevLineType = 'code';
				return;
			}
			if (wasEmptyCodeLine) {
				push('');
			}
			if (!isEmpty) {
				push(line);
			}
			var assertPrintedMatch = line.match(/\/\/ -> (.*)/);
			if (assertPrintedMatch) {
				var matches = assertPrintedMatch[1].split('; ');
				matches.forEach(function(output) {
					push("\tassertPrinted('" + output + "');");
				});
			}
			if (line.match(/\/\/ no effect/)) {
				push("\tassertPrinted(null);");
			}
			prevLineType = 'code';
		} else {
			if (prevLineType === 'code') {
				push('})();');
			}
			if (wasEmptyCommentLine) {
				prevComment = [];
			}
			prevComment.push(line);
			prevLineType = 'comment';
		}
		wasEmptyCodeLine = followsCodeLine && isEmpty;
		wasEmptyCommentLine = followsCommentLine && isEmpty;
	});
	if (prevLineType === 'code') {
		push('})();');
	}
});


var testJs = fs.readFileSync('misc/test-prelude.js', 'utf8') +
	testLines.join('\n');

console.log(testJs);

